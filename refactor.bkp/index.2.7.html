<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chicken Clicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        :root {
            --saddle-brown: #8B4513;
            --light-peach: #FFDDC1;
            --burly-wood: #DEB887;
        }
        html { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            user-select: none;
            background-color: var(--light-peach);
            background-image:
                radial-gradient(var(--saddle-brown) 15%, transparent 16%),
                radial-gradient(var(--saddle-brown) 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            touch-action: manipulation;
        }
        @media (min-width: 768px) {
            body {
                justify-content: center;
                align-items: center;
                padding: 1rem;
            }
        }
        .funky-font {
            font-family: 'Luckiest Guy', cursive;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }
        .chicken-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 300px;
            flex-grow: 1;
        }
        .chicken {
            cursor: pointer;
            transition: transform 0.1s ease-out;
            width: 100%;
            height: auto;
            filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.3));
        }
        .chicken:active { transform: scale(0.95) rotate(-2deg); }
        .floating-text {
            position: absolute;
            font-family: 'Luckiest Guy', cursive;
            font-size: 2.5rem;
            color: #FFD700;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
        }
        .super-click-text {
             font-size: 3.5rem;
             color: #f472b6; /* Pink */
        }
        @keyframes floatUp {
            from { opacity: 1; transform: translateY(0) rotate(0deg); }
            to { opacity: 0; transform: translateY(-120px) rotate(15deg); }
        }
        .golden-chicken, .colored-egg {
            position: absolute; /* Contained within app-wrapper */
            cursor: pointer;
            transition: transform 0.2s, opacity 0.5s;
            z-index: 100;
            display: none;
        }
        .golden-chicken {
            width: 80px; height: 80px;
            animation: shimmer 1.5s infinite;
            filter: drop-shadow(0 0 15px gold);
        }
        .colored-egg {
            width: 40px; height: 50px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .golden-chicken:hover { transform: scale(1.2) rotate(10deg); }
        @keyframes shimmer {
            0% { filter: brightness(1) drop-shadow(0 0 15px gold); }
            50% { filter: brightness(1.7) drop-shadow(0 0 25px gold); }
            100% { filter: brightness(1) drop-shadow(0 0 15px gold); }
        }
        .achievement-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #f3ec78, #af4261);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            z-index: 1100; /* Above modals */
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
            border: 4px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            max-width: 90%;
            text-align: center;
        }
        .achievement-toast.show { opacity: 1; transform: translateX(-50%) translateY(-20px) scale(1); }
        .game-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 5px solid var(--saddle-brown);
            border-radius: 20px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
        }
        .funky-button {
            border-radius: 12px;
            font-weight: bold;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        .funky-button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .funky-button:active { transform: translateY(1px); border-bottom-width: 2px; }
        .funky-button:disabled { background-color: #9ca3af !important; color: #e5e7eb !important; cursor: not-allowed; border-bottom-color: #6b7280; transform: translateY(0); filter: brightness(1); }

        .modal-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-content {
            width: 100%; max-width: 500px;
            height: 90%; max-height: 700px;
            background-color: var(--light-peach);
            border-radius: 20px;
            border: 8px solid var(--saddle-brown);
            padding: 1rem;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 0.5rem;
        }
        .close-modal-btn {
            position: absolute;
            top: -15px; right: -15px;
            width: 40px; height: 40px;
            background: var(--saddle-brown);
            color: white;
            border-radius: 50%;
            border: 4px solid white;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%; height: 65px;
            background-color: var(--saddle-brown);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            z-index: 50;
        }
        .nav-button {
            background: none; border: none;
            color: white;
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; font-weight: bold;
            cursor: pointer;
            padding: 0.5rem; border-radius: 8px;
            transition: background-color 0.2s;
        }
        .nav-button:hover { background-color: rgba(255,255,255,0.2); }
        .nav-button svg { width: 28px; height: 28px; margin-bottom: 2px; }
        #event-banner {
            display: none;
            position: absolute; /* Contained within wrapper */
            top: 0; left: 0;
            width: 100%;
            background: linear-gradient(45deg, #fceabb, #f8b500);
            color: #333;
            text-align: center;
            padding: 0.5rem;
            z-index: 500;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #achievement-screenshot-template {
            position: absolute;
            left: -9999px; top: -9999px;
            width: 500px; padding: 20px;
            background-color: var(--light-peach);
            background-image:
                radial-gradient(var(--saddle-brown) 15%, transparent 16%),
                radial-gradient(var(--saddle-brown) 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            border: 10px solid var(--saddle-brown);
            border-radius: 15px;
            color: white;
        }
        /* Help modal specific styles */
        #help-screen .modal-body h3, #settings-screen .changelog-details h4 {
            font-family: 'Luckiest Guy', cursive;
            font-size: 1.75rem;
            color: var(--saddle-brown);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 3px solid var(--burly-wood);
            padding-bottom: 0.25rem;
        }
        #help-screen .modal-body p, #settings-screen .changelog-details ul {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        #help-screen .modal-body strong {
            color: var(--saddle-brown);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-wrapper" class="w-full h-full md:max-w-lg md:h-[850px] md:relative md:border-8 md:border-[var(--saddle-brown)] md:rounded-2xl md:shadow-2xl md:overflow-hidden flex flex-col bg-cover bg-center" style="background-image: url('https://www.transparenttextures.com/patterns/hay-bale.png');">
    
        <div id="game-container" class="flex flex-col h-full relative">
            <div id="event-banner" class="funky-font text-xl md:text-2xl"></div>
            <div id="colored-egg-container" class="absolute inset-0"></div>

            <header class="text-center pt-6 pb-2">
                <h1 class="text-5xl md:text-7xl funky-font text-white" style="text-shadow: 4px 4px 0px var(--saddle-brown);">Chicken Clicker</h1>
                 <p id="player-name-display" class="funky-font text-2xl text-yellow-300" style="text-shadow: 2px 2px 0px var(--saddle-brown);"></p>
            </header>

            <div id="egg-stats" class="text-center mb-4 p-2 mx-4 game-card">
                <h2 id="egg-counter" class="text-4xl md:text-5xl funky-font text-blue-600">0 Eggs</h2>
                <div class="flex justify-center items-center gap-4">
                    <p id="feather-counter" class="text-xl md:text-2xl funky-font text-yellow-600">0 Golden Feathers</p>
                </div>
                <p id="eggs-per-second" class="text-lg md:text-xl font-bold">per second: 0</p>
                <p id="eggs-per-click" class="text-lg md:text-xl font-bold">per click: 1</p>
            </div>

            <main class="flex-grow flex justify-center items-center px-4 pb-20">
                <div class="chicken-container">
                    <svg id="chicken" class="chicken" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <title>A majestic chicken</title>
                        <path d="M 25,75 C -10,90 10,30 50,30 C 90,30 110,90 75,75 C 60,95 40,95 25,75 Z" fill="white" stroke="black" stroke-width="3"/>
                        <circle cx="65" cy="25" r="15" fill="white" stroke="black" stroke-width="3"/>
                        <path d="M 60,12 C 60,5 70,5 70,12 C 75,5 80,8 75,15 L 60,15 Z" fill="red" stroke="black" stroke-width="2"/>
                        <path d="M 78,25 L 88,30 L 78,35 Z" fill="orange" stroke="black" stroke-width="2"/>
                        <path d="M 75,32 C 75,40 70,40 70,32" fill="red" stroke="black" stroke-width="2"/>
                        <circle cx="70" cy="23" r="2" fill="black"/>
                        <path d="M 20,60 C 5,50 5,30 25,40" fill="none" stroke="black" stroke-width="3"/>
                        <path d="M 25,65 C 10,55 10,35 30,45" fill="none" stroke="black" stroke-width="3"/>
                    </svg>
                </div>
            </main>
        </div>

        <nav class="bottom-nav md:absolute">
             <button class="nav-button" data-modal="upgrades-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75 12 3m0 0 3.75 3.75M12 3v18" /></svg>
                <span>Upgrades</span>
            </button>
            <button class="nav-button" data-modal="coop-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205 3 1m-3-1-3-1.091m0 3.273 3 1.091M5.25 6.086 3 7.091m0 0L2.25 9l4.5-1.636M7.5 3l1.5.545M7.5 10.75l3 1.091m0-3.273-3-1.091" /></svg>
                <span>The Coop</span>
            </button>
            <button class="nav-button" data-modal="achievements-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 1 0 0-13.5h9a9.75 9.75 0 1 0 0 13.5ZM10.5 12.75h3" /></svg>
                <span>Achievements</span>
            </button>
            <button class="nav-button" data-modal="help-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>
                <span>Help</span>
            </button>
            <button class="nav-button" data-modal="settings-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226.554-.22 1.196-.22 1.75 0 .554.22 1.02.684 1.11 1.226l.08 1.113c.093.124.19.242.292.356.102.115.21.223.324.32l1.028.747c.456.33.974.543 1.52.543.547 0 1.065-.213 1.495-.543l1.028-.747c.114-.097.222-.205.324-.32.102-.114.2-.232.292-.356l.08-1.113c.09-.542.56-1.007 1.11-1.226.554-.22 1.196-.22 1.75 0 .554.22 1.02.684 1.11 1.226l.08 1.113c.093.124.19.242.292.356.102.115.21.223.324.32l1.028.747c.456.33.974.543 1.52.543.547 0 1.065-.213 1.495-.543l1.028-.747c.114-.097.222-.205.324-.32.102-.114.2-.232.292-.356l.08-1.113c.09-.542.56-1.007 1.11-1.226.554-.22 1.196-.22 1.75 0 .554.22 1.02.684 1.11 1.226l.08 1.113c.093.124.19.242.292.356.102.115.21.223.324.32l1.028.747c.456.33.974.543 1.52.543.547 0 1.065-.213 1.495-.543l1.028-.747c.114-.097.222-.205.324-.32.102-.114.2-.232.292-.356l.08-1.113a1.5 1.5 0 0 0-2.22-1.664l-1.028.747a1.5 1.5 0 0 1-1.875 0l-1.028-.747a1.5 1.5 0 0 0-1.664-2.22l-1.113.08c-.124.093-.242.19-.356.292-.115.102-.223.21-.32.324l-.747 1.028a1.5 1.5 0 0 0 0 1.875l.747 1.028c.097.114.205.222.32.324.114.102.232.2.356.292l1.113.08c.602.09 1.15-.155 1.485-.62l.747-1.028a1.5 1.5 0 0 1 2.22-.162l.08 1.113c.09.542-.155 1.15-.62 1.485l-1.028.747a1.5 1.5 0 0 1-1.875 0l-1.028-.747a1.5 1.5 0 0 0-1.664 2.22l-1.113-.08c-.124-.093-.242-.19-.356-.292-.115-.102-.223-.21-.32-.324l-.747-1.028a1.5 1.5 0 0 0 0-1.875l.747-1.028c.097-.114.205-.222.32-.324.114-.102.232-.2.356-.292l1.113-.08a1.5 1.5 0 0 0 1.485.62l.747 1.028a1.5 1.5 0 0 1-2.22.162l-.08-1.113a1.5 1.5 0 0 0-1.485-.62l-.747-1.028a1.5 1.5 0 0 1 0-1.875l.747-1.028c.335-.465.933-.71 1.485-.62l1.113.08c.124.093.242.19.356.292.115.102.223.21.32.324l.747 1.028a1.5 1.5 0 0 0 1.875 0l.747-1.028a1.5 1.5 0 0 1 1.664-2.22l1.113.08c.602.09 1.15-.155 1.485-.62l.747-1.028a1.5 1.5 0 0 0 0-1.875l-.747-1.028c-.335-.465-.933-.71-1.485-.62l-1.113.08c-.124.093-.242-.19-.356-.292-.115-.102-.223-.21-.32.324l-.747 1.028a1.5 1.5 0 0 1-1.875 0l-.747-1.028a1.5 1.5 0 0 0-1.664-2.22z" /></svg>
                <span>Settings</span>
            </button>
        </nav>
    </div>

    <div id="name-modal" class="modal-screen">
        <div class="modal-content">
            <h2 class="funky-font text-4xl text-center text-white mb-4" style="text-shadow: 3px 3px 0px var(--saddle-brown);">Welcome, Farmer!</h2>
            <div class="modal-body flex flex-col justify-center items-center space-y-4">
                <label for="initial-nickname-input" class="funky-font text-2xl text-white" style="text-shadow: 2px 2px 0px var(--saddle-brown);">What's your name?</label>
                <input type="text" id="initial-nickname-input" placeholder="Enter Nickname" class="w-full max-w-xs text-center funky-font bg-white/80 border-4 border-[#8B4513] rounded-lg p-2 text-xl text-[#8B4513] placeholder:text-gray-500/80 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                <button id="start-game-btn" class="w-full max-w-xs funky-button bg-green-500 text-white">Start Cluckin'</button>
            </div>
        </div>
    </div>

    <div id="upgrades-screen" class="modal-screen">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h2 class="funky-font text-4xl text-center text-white mb-4" style="text-shadow: 3px 3px 0px var(--saddle-brown);">Upgrades</h2>
            <div id="upgrades-list" class="modal-body space-y-4">
                </div>
        </div>
    </div>

    <div id="coop-screen" class="modal-screen">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h2 class="funky-font text-4xl text-center text-white mb-4" style="text-shadow: 3px 3px 0px var(--saddle-brown);">The Coop</h2>
            <div id="coop-list" class="modal-body space-y-4">
                </div>
        </div>
    </div>

    <div id="achievements-screen" class="modal-screen">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h2 class="funky-font text-4xl text-center text-white mb-4" style="text-shadow: 3px 3px 0px var(--saddle-brown);">Achievements</h2>
            <div class="modal-body">
                <div id="achievements-list" class="space-y-2 pr-2"></div>
                <div class="mt-6">
                    <h3 class="text-3xl funky-font text-center mb-4 border-b-4 border-gray-200 pb-2">Prestige</h3>
                    <div class="bg-purple-200 p-4 rounded-lg border-2 border-purple-400">
                        <h4 class="text-2xl funky-font">Sell the Coop</h4>
                        <p class="text-gray-600 mb-2">Reset progress for a permanent production boost. Requires 1 Trillion eggs.</p>
                        <p>Reputation: <span id="reputation-points" class="font-bold">0</span> (+<span id="reputation-bonus" class="font-bold">0</span>% bonus)</p>
                        <p class="text-sm text-gray-500">Achievement Bonus: <span id="achievement-bonus-ui" class="font-bold">+0</span>%</p>
                        <p class="text-sm text-gray-500">Permanent Bonus: <span id="permanent-bonus-ui" class="font-bold">x1.00</span></p>
                        <hr class="my-1 border-purple-400">
                        <p class="font-bold">Total Production Multiplier: <span id="total-multiplier-ui" class="font-bold">x1.00</span></p>
                        <button id="prestige-button" class="w-full mt-2 funky-button bg-purple-600 text-white">Sell Coop</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="help-screen" class="modal-screen">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h2 class="funky-font text-4xl text-center text-white mb-4" style="text-shadow: 3px 3px 0px var(--saddle-brown);">How to Play</h2>
            <div class="modal-body">
                <h3>Core Currencies & Stats</h3>
                <p><strong>Eggs:</strong> The primary currency of the game. Earned by clicking the chicken and through automatic production (EPS). Used to buy most upgrades and chickens.</p>
                <p><strong>Golden Feathers:</strong> A premium currency used to purchase powerful, specific upgrades like the "Golden Loom". Primarily earned by owning Silkie Chickens.</p>
                <p><strong>Reputation:</strong> The prestige currency. Earned by "Selling the Coop" (prestiging). Each point provides a permanent production bonus to both your automatic and manual egg generation.</p>
                <p><strong>EPS (Eggs Per Second):</strong> The total number of eggs you generate automatically every second from your chickens and upgrades. This is the main driver of progress in the mid-to-late game.</p>
                <p><strong>EPC (Eggs Per Click):</strong> The total number of eggs you receive for each manual click on the chicken. This is your primary source of income at the start of the game.</p>
                
                <h3>Key Concepts & Mechanics</h3>
                <p><strong>Upgrades:</strong> Permanent improvements that boost your production or unlock new game mechanics. They are purchased from the "Upgrades" screen.</p>
                <p><strong>The Coop:</strong> The screen where you can purchase different types of specialized chickens. Each chicken provides a unique bonus, such as increasing EPS, finding Golden Feathers, or generating Reputation.</p>
                <p><strong>Prestige ("Sell the Coop"):</strong> A core mechanic in idle games. When you reach a certain threshold (1 Trillion eggs), you can choose to reset your current progress (eggs, upgrades, chickens) in exchange for <strong>Reputation</strong> points. This makes the next playthrough faster due to the permanent bonus Reputation provides.</p>
                <p><strong>Golden Chicken:</strong> A special chicken that randomly appears on the screen. Clicking it before it disappears awards a large, instant bonus of Eggs, typically equal to a significant portion of your income.</p>
                <p><strong>Colored Eggs:</strong> Rare, colored eggs that spawn randomly on the screen. Clicking one grants a powerful but temporary boost (a "buff"), such as making clicks stronger, discounting upgrades, or increasing the chance of finding Golden Feathers.</p>
                <p><strong>Achievements:</strong> Milestones unlocked by reaching specific goals (e.g., total eggs earned, number of clicks, owning certain items). Each unlocked achievement provides a small, permanent, and multiplicative bonus to all egg production.</p>
                <p><strong>Buff:</strong> A temporary positive effect on your game, usually granted by clicking a Colored Egg.</p>
                <p><strong>Hard Reset:</strong> An option in the settings menu to completely and permanently erase all your save data and start the game over from the very beginning.</p>
            </div>
        </div>
    </div>
    
    <div id="settings-screen" class="modal-screen">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h2 class="funky-font text-4xl text-center text-white mb-4" style="text-shadow: 3px 3px 0px var(--saddle-brown);">Settings</h2>
            <div class="modal-body space-y-6">
                <div>
                    <label for="nickname-input" class="funky-font text-2xl text-white" style="text-shadow: 2px 2px 0px var(--saddle-brown);">Nickname</label>
                    <input type="text" id="nickname-input" placeholder="Enter Your Nickname" class="w-full text-center funky-font bg-white/80 border-4 border-[#8B4513] rounded-lg p-2 text-xl text-[#8B4513] placeholder:text-gray-500/80 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                </div>

                <div>
                    <h3 class="funky-font text-2xl text-white" style="text-shadow: 2px 2px 0px var(--saddle-brown);">Save Management</h3>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button id="export-save-clipboard" class="funky-button bg-blue-500 text-white text-sm">To Clipboard</button>
                        <button id="export-save-file" class="funky-button bg-blue-500 text-white text-sm">To File</button>
                    </div>
                    <textarea id="import-save-text" class="w-full mt-2 p-2 rounded-lg border-2 border-gray-400" rows="3" placeholder="Paste save data here..."></textarea>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button id="import-save-text-btn" class="funky-button bg-green-500 text-white text-sm">From Text</button>
                        <button id="import-save-file-btn" class="funky-button bg-green-500 text-white text-sm">From File</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".txt, .sav">
                    </div>
                </div>

                <div>
                    <h3 class="funky-font text-2xl text-white" style="text-shadow: 2px 2px 0px var(--saddle-brown);">Danger Zone</h3>
                     <button id="reset-button" class="w-full mt-2 funky-button bg-red-600 text-white">Hard Reset Game</button>
                </div>
                
                <div>
                    <details class="changelog-details text-sm text-gray-800 bg-white/50 p-2 rounded-lg">
                        <summary class="font-bold text-gray-800 cursor-pointer">Changelog</summary>
                        <div class="mt-2 space-y-2 text-xs">
                            <h4>Version 2.7 (Banty Shack)</h4>
                            <ul class="list-disc pl-5">
                                <li><strong>Feature:</strong> Implemented Offline Progress! The game now calculates and awards resources earned while you were away.</li>
                                <li><strong>UI:</strong> Added a "Welcome Back" modal to show offline gains.</li>
                                <li><strong>Housekeeping:</strong> Updated version number and save key to 2.7.</li>
                            </ul>
                            <h4>Version 2.6 (Tarzan)</h4>
                            <ul class="list-disc pl-5">
                                <li><strong>Balance:</strong> Changed achievement bonuses from multiplicative to additive to prevent runaway late-game scaling.</li>
                                <li><strong>UI:</strong> The prestige menu now displays a full breakdown of all permanent production multipliers for better clarity.</li>
                                <li><strong>Feature:</strong> Implemented the previously non-functional "Orpington Oracle" chicken. It now provides a random egg bonus every 10 minutes.</li>
                                <li><strong>Fix:</strong> The "Wyandotte Warrior" now correctly increases Reputation gained on prestige, as described.</li>
                                <li><strong>Housekeeping:</strong> Updated version number and save key to 2.6.</li>
                            </ul>
                            <h4>Version 2.5 (Totoro)</h4>
                            <ul class="list-disc pl-5">
                                <li>Added a comprehensive "Help" screen.</li>
                                <li>Implemented save import/export functionality.</li>
                                <li>Fixed a critical bug related to the "Nest Egg IRA" upgrade causing `Infinity` eggs.</li>
                                <li>Corrected the "Doja Cow's" Super Click chain bonus logic.</li>
                                <li>Fixed non-functional "Discount" and "Feather Frenzy" buffs.</li>
                                <li>Ensured the "Hard Reset" achievement is now obtainable.</li>
                                <li>Updated save file key to v2.5.</li>
                            </ul>
                             <h4>Version 2.4 (DOJACOW)</h4>
                            <ul class="list-disc pl-5">
                                <li>Merged all project files into a single `index.html` for simplicity.</li>
                                <li>Fixed a critical bug preventing upgrade/coop colors from displaying.</li>
                            </ul>
                            </div>
                    </details>
                </div>

                <div>
                    <details class="license-details text-sm text-gray-800 bg-white/50 p-2 rounded-lg">
                        <summary id="license-summary" class="font-bold text-gray-800 cursor-pointer">MIT License</summary>
                        <div class="mt-2 space-y-2 text-xs">
                            <p class="font-normal">Copyright (c) 2025 KokanP</p>
                            <p class="font-normal">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
                            <p class="font-normal">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
                            <p class="font-normal">THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
                        </div>
                    </details>
                </div>
                <div class="text-center text-gray-600">
                    <p>Version: <span id="version-number">2.7 Banty Shack</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Offline Progress Modal -->
    <div id="offline-progress-modal" class="modal-screen">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h2 class="funky-font text-4xl text-center text-white mb-4" style="text-shadow: 3px 3px 0px var(--saddle-brown);">Welcome Back!</h2>
            <div id="offline-recap" class="modal-body flex flex-col justify-center items-center space-y-4 text-center">
                <p>While you were away for <strong id="offline-time">0 seconds</strong>, your farm produced:</p>
                <div class="space-y-2 text-2xl funky-font">
                    <p id="offline-eggs-line" class="text-blue-600 hidden">0 Eggs</p>
                    <p id="offline-feathers-line" class="text-yellow-600 hidden">0 Golden Feathers</p>
                    <p id="offline-rep-line" class="text-purple-600 hidden">0 Reputation</p>
                </div>
            </div>
        </div>
    </div>

    <div id="achievement-screenshot-template">
        <h2 class="funky-font text-4xl text-center" style="text-shadow: 3px 3px 0px var(--saddle-brown);">Achievement Unlocked!</h2>
        <div class="text-center mt-4">
            <p id="screenshot-nickname" class="funky-font text-3xl text-yellow-300" style="text-shadow: 2px 2px 0px var(--saddle-brown);"></p>
            <p class="text-xl font-bold mt-1" style="text-shadow: 1px 1px 0px #000;">has achieved</p>
            <p id="screenshot-ach-name" class="funky-font text-4xl mt-2" style="text-shadow: 2px 2px 0px var(--saddle-brown);"></p>
            <p id="screenshot-ach-desc" class="text-lg font-semibold mt-1" style="text-shadow: 1px 1px 0px #000;"></p>
            <p id="screenshot-date" class="text-md mt-6 font-bold" style="text-shadow: 1px 1px 0px #000;"></p>
        </div>
    </div>
    <svg id="golden-chicken" class="golden-chicken" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#FFDF00;stop-opacity:1" /><stop offset="100%" style="stop-color:#B8860B;stop-opacity:1" /></linearGradient></defs>
        <path d="M 25,75 C -10,90 10,30 50,30 C 90,30 110,90 75,75 C 60,95 40,95 25,75 Z" fill="url(#gold-gradient)" stroke="#8B4513" stroke-width="3"/>
        <circle cx="65" cy="25" r="15" fill="url(#gold-gradient)" stroke="#8B4513" stroke-width="3"/>
        <path d="M 60,12 C 60,5 70,5 70,12 C 75,5 80,8 75,15 L 60,15 Z" fill="red" stroke="#8B4513" stroke-width="2"/>
        <path d="M 78,25 L 88,30 L 78,35 Z" fill="orange" stroke="#8B4513" stroke-width="2"/>
        <path d="M 75,32 C 75,40 70,40 70,32" fill="red" stroke="#8B4513" stroke-width="2"/>
        <circle cx="70" cy="23" r="2" fill="black"/>
        <path d="M 20,60 C 5,50 5,30 25,40" fill="none" stroke="#8B4513" stroke-width="3"/>
        <path d="M 25,65 C 10,55 10,35 30,45" fill="none" stroke="#8B4513" stroke-width="3"/>
    </svg>
    <div id="achievement-toast" class="achievement-toast funky-font">
        <strong id="toast-title">Achievement Unlocked!</strong>
        <p id="toast-description">You're a natural!</p>
    </div>

    <script type="module">
        // --- Single-File Merged JavaScript for Chicken Clicker ---

        // --- config.js content ---
        const CONFIG = {
            SAVE_KEY: 'chickenClickerSave_v2.7', // Updated save key for the new version
            GAME_VERSION: '2.7 Doc', // Updated version number
            GAME_TICK_INTERVAL: 0.1,
            SAVE_INTERVAL: 5,
            GOLDEN_CHICKEN_SPAWN_INTERVAL: 60,
            RANDOM_EVENT_INTERVAL: 180,
            COLORED_EGG_ATTEMPT_INTERVAL: 15,
            COLORED_EGG_SPAWN_CHANCE: 10 / 240,
            PRESTIGE_COST: 1e12,
            UPGRADES: {
                worker: { name: 'Coop Worker', desc: 'Helps Leghorns produce eggs automatically.', baseCost: 10, exponent: 1.15, currency: 'eggs', color: 'green' },
                incubator: { name: 'Incubator', desc: 'Increases eggs per click.', baseCost: 50, exponent: 1.15, currency: 'eggs', color: 'blue' },
                loom: { name: 'Golden Loom', desc: 'Uses Golden Feathers to massively boost eggs per click.', baseCost: 10, exponent: 1.5, currency: 'feathers', color: 'yellow' },
                featherForecast: { name: 'Feather Forecast', desc: 'Increases Golden Feather find chance.', baseCost: 10000, exponent: 1.8, currency: 'eggs', color: 'gray' },
                eggstraClicks: { name: 'Eggstra Clicks', desc: 'Each click has a chance to be 10x stronger.', baseCost: 50000, exponent: 1.25, currency: 'eggs', color: 'pink' },
                cluckworkAutomation: { name: 'Cluckwork Automation', desc: 'Boosts EPS by 5% for every building owned.', baseCost: 1e6, exponent: 2, currency: 'eggs', color: 'purple' },
                peckingOrder: { name: 'Pecking Order', desc: 'A flat +10% boost to both clicks and EPS.', baseCost: 1e7, exponent: 1.5, currency: 'eggs', color: 'indigo' },
                nestEggIRA: { name: 'Nest Egg IRA', desc: 'Earn 0.1% of your base EPS as interest per second (capped).', baseCost: 1e9, exponent: 2.5, currency: 'eggs', color: 'teal' },
                fowlLanguage: { name: 'Fowl Language', desc: 'The chicken occasionally squawks insults. Essential.', baseCost: 1e12, exponent: 10, currency: 'eggs', color: 'red' }
            },
            CHICKENS: {
                leghorn: { name: 'Leghorn Chicken', desc: 'The backbone of your coop. Produces 1 egg/s per Coop Worker.', baseCost: 1000, exponent: 1.25, color: 'gray' },
                silkie: { name: 'Silkie Chicken', desc: 'Produces fewer eggs but has a chance to find Golden Feathers.', baseCost: 5000, exponent: 1.25, color: 'orange' },
                rooster: { name: 'Rooster', desc: 'Doesn\'t lay eggs. Generates Reputation instead.', baseCost: 1e6, exponent: 1.25, color: 'red' },
                orpington: { name: 'Orpington Oracle', desc: 'Grants a random egg bonus every 10 minutes.', baseCost: 1e8, exponent: 1.3, color: 'yellow' },
                wyandotte: { name: 'Wyandotte Warrior', desc: 'Increases Reputation gained on prestige.', baseCost: 1e10, exponent: 1.35, color: 'blue' },
                doja: { name: 'Doja Cow', desc: '"Moooove over!" Each click has a chance to be a "Super Click", granting 1 hour of EPS.', baseCost: 5e12, exponent: 1.4, color: 'pink' },
                brahma: { name: 'Brahma Behemoth', desc: 'A gentle giant. Adds a massive +500% to your base EPS.', baseCost: 1e15, exponent: 1.45, color: 'green' },
                serama: { name: 'Serama Sorcerer', desc: 'Has a chance to grant a free upgrade level.', baseCost: 1e18, exponent: 1.5, color: 'purple' },
                banty: { name: 'Banty Chicken', desc: 'The king. Provides a +10% multiplicative bonus to ALL production.', baseCost: 1e21, exponent: 1.6, color: 'indigo' }
            },
            COLORED_EGGS: {
                green:  { likelihood: 15, effect: 'discount', value: 0.1, duration: 5, color: '#4ade80' },
                red:    { likelihood: 15, effect: 'clickFrenzy', value: 5, duration: 30, color: '#f87171' },
                pink:   { likelihood: 14, effect: 'instantGain', value: 1800, duration: 0, color: '#f472b6' },
                orange: { likelihood: 14, effect: 'featherFrenzy', value: 2, duration: 600, color: '#fb923c' },
                yellow: { likelihood: 13, effect: 'goldRush', value: 3, duration: 0, color: '#facc15' },
                white:  { likelihood: 10, effect: 'boostMultiplier', value: 2, duration: 60, color: '#f9fafb' },
                black:  { likelihood: 6,  effect: 'superClickFrenzy', value: 2, duration: 60, color: '#1f2937' },
                blue:   { likelihood: 6,  effect: 'prestigeBuff', value: 0.1, duration: -1, color: '#60a5fa' },
                purple: { likelihood: 3,  effect: 'prestigePercent', value: 0.01, duration: 0, color: '#a78bfa' },
                gold:   { likelihood: 1,  effect: 'permanentBonus', value: 0.01, duration: -1, color: 'gold' }
            }
        };
        const achievements = {
            click1: { name: "First Peck", description: "Click the chicken once.", bonus: 1.01 },
            click1k: { name: "Click Addict", description: "Click 1,000 times.", bonus: 1.02 },
            click100k: { name: "Carpal Tunnel Hopeful", description: "Click 100,000 times.", bonus: 1.05 },
            click1M: { name: "Million-Click March", description: "Click 1,000,000 times.", bonus: 1.1 },
            egg1k: { name: "First Dozen", description: "Earn 1,000 total eggs.", bonus: 1.01 },
            egg1M: { name: "Egg Millionaire", description: "Earn 1,000,000 total eggs.", bonus: 1.03 },
            egg1B: { name: "Egg Billionaire", description: "Earn 1,000,000,000 total eggs.", bonus: 1.05 },
            egg1T: { name: "Trillionaire's Omelette", description: "Earn 1 Trillion total eggs.", bonus: 1.1 },
            worker25: { name: "Coop Manager", description: "Own 25 Coop Workers.", bonus: 1.02 },
            worker100: { name: "Foreman of the Flock", description: "Own 100 Coop Workers.", bonus: 1.05 },
            incubator25: { name: "Industrial Revolution", description: "Own 25 Incubators.", bonus: 1.02 },
            incubator100: { name: "Clickpocalypse", description: "Own 100 Incubators.", bonus: 1.05 },
            loom1: { name: "Golden Threads", description: "Build your first Golden Loom.", bonus: 1.05 },
            loom10: { name: "Rich Tapestry", description: "Own 10 Golden Looms.", bonus: 1.1 },
            featherForecast1: { name: "Good Omen", description: "Buy a Feather Forecast.", bonus: 1.02 },
            eggstraClicks1: { name: "Lucky Break", description: "Buy an Eggstra Clicks.", bonus: 1.02 },
            cluckworkAutomation1: { name: "Synergy", description: "Buy Cluckwork Automation.", bonus: 1.03 },
            peckingOrder1: { name: "Top of the Order", description: "Buy a Pecking Order.", bonus: 1.03 },
            nestEggIRA1: { name: "Retirement Plan", description: "Start a Nest Egg IRA.", bonus: 1.05 },
            fowlLanguage1: { name: "Why I Oughta!", description: "Buy Fowl Language.", bonus: 1.01 },
            silkie1: { name: "Fluffy", description: "Buy your first Silkie Chicken.", bonus: 1.02 },
            rooster1: { name: "Cocky", description: "Buy your first Rooster.", bonus: 1.02 },
            orpington1: { name: "Fortune Teller", description: "Buy an Orpington Oracle.", bonus: 1.03 },
            wyandotte1: { name: "Reputable", description: "Buy a Wyandotte Warrior.", bonus: 1.03 },
            doja1: { name: "Moooove Over", description: "Buy a Doja Cow.", bonus: 1.05 },
            brahma1: { name: "Gentle Giant", description: "Buy a Brahma Behemoth.", bonus: 1.05 },
            serama1: { name: "Freebie!", description: "Buy a Serama Sorcerer.", bonus: 1.07 },
            banty1: { name: "King of the Coop", description: "Buy the legendary Banty Chicken.", bonus: 1.1 },
            secondChance: { name: "Second Chance", description: "Prestige for the first time.", bonus: 1.10 },
            eternalFarmer: { name: "Eternal Farmer", description: "Prestige 10 times.", bonus: 1.25 },
            prestigeWorldwide: { name: "Prestige Worldwide", description: "Prestige 25 times.", bonus: 1.5 },
            goldenTouch: { name: "Golden Touch", description: "Click your first Golden Chicken.", bonus: 1.02 },
            goldRush: { name: "Gold Rush", description: "Click 10 Golden Chickens.", bonus: 1.10 },
            goldFever: { name: "Gold Fever", description: "Click 50 Golden Chickens.", bonus: 1.2 },
            eggGreen: { name: "Going Green", description: "Find a Green Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggRed: { name: "Seeing Red", description: "Find a Red Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggPink: { name: "In the Pink", description: "Find a Pink Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggOrange: { name: "Orange You Glad", description: "Find an Orange Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggYellow: { name: "Mellow Yellow", description: "Find a Yellow Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggWhite: { name: "Plain and Simple", description: "Find a White Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggBlack: { name: "Back in Black", description: "Find a Black Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggBlue: { name: "Feeling Blue", description: "Find a Blue Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggPurple: { name: "Purple Reign", description: "Find a Purple Egg.", bonus: 1.01, hidden: true, noToast: true },
            eggGold: { name: "Midas Touch", description: "Find a Gold Egg.", bonus: 1.05, hidden: true, noToast: true },
            impatient: { name: "Impatient", description: "Try to buy something you can't afford 50 times.", bonus: 1.01, hidden: true },
            license: { name: "License and Registration", description: "Read the license.", bonus: 1.01, hidden: true },
            reset: { name: "What Did It Do To You?", description: "Use the Hard Reset button.", bonus: 1.00, hidden: true },
            lazy: { name: "Are You Even Trying?", description: "Don't click the chicken for the first 2 minutes.", bonus: 1.05, hidden: true },
            loner: { name: "Just Me and My Chicken", description: "Reach 1M eggs without buying any Coop Workers.", bonus: 1.10, hidden: true },
            afk: { name: "Still There?", description: "Don't click anything for 15 minutes.", bonus: 1.1, hidden: true },
            indecisive: { name: "Window Shopper", description: "Open and close a modal 50 times.", bonus: 1.02, hidden: true },
            justTheBasics: { name: "Old School", description: "Reach 10M eggs using only Leghorn Chickens.", bonus: 1.15, hidden: true },
            allUpgrades: { name: "Master Builder", description: "Buy at least one of every upgrade.", bonus: 1.2, hidden: true },
            allChickens: { name: "Gotta Cluck 'Em All", description: "Own at least one of every chicken.", bonus: 1.2, hidden: true },
            eggCollector: { name: "Taste the Rainbow", description: "Find one of every colored egg.", bonus: 1.25, hidden: true },
        };
        const achievementConditions = {
            click1: (gs) => gs.totalClicks >= 1, click1k: (gs) => gs.totalClicks >= 1000, click100k: (gs) => gs.totalClicks >= 100000, click1M: (gs) => gs.totalClicks >= 1e6,
            egg1k: (gs) => gs.totalEggs >= 1000, egg1M: (gs) => gs.totalEggs >= 1e6, egg1B: (gs) => gs.totalEggs >= 1e9, egg1T: (gs) => gs.totalEggs >= 1e12,
            worker25: (gs) => gs.upgrades.worker >= 25, worker100: (gs) => gs.upgrades.worker >= 100,
            incubator25: (gs) => gs.upgrades.incubator >= 25, incubator100: (gs) => gs.upgrades.incubator >= 100,
            loom1: (gs) => gs.upgrades.loom >= 1, loom10: (gs) => gs.upgrades.loom >= 10,
            featherForecast1: (gs) => gs.upgrades.featherForecast >= 1, eggstraClicks1: (gs) => gs.upgrades.eggstraClicks >= 1,
            cluckworkAutomation1: (gs) => gs.upgrades.cluckworkAutomation >= 1, peckingOrder1: (gs) => gs.upgrades.peckingOrder >= 1,
            nestEggIRA1: (gs) => gs.upgrades.nestEggIRA >= 1, fowlLanguage1: (gs) => gs.upgrades.fowlLanguage >= 1,
            silkie1: (gs) => gs.chickens.silkie >= 1, rooster1: (gs) => gs.chickens.rooster >= 1,
            orpington1: (gs) => gs.chickens.orpington >= 1, wyandotte1: (gs) => gs.chickens.wyandotte >= 1,
            doja1: (gs) => gs.chickens.doja >= 1, brahma1: (gs) => gs.chickens.brahma >= 1,
            serama1: (gs) => gs.chickens.serama >= 1, banty1: (gs) => gs.chickens.banty >= 1,
            secondChance: (gs) => gs.prestigeCount >= 1, eternalFarmer: (gs) => gs.prestigeCount >= 10, prestigeWorldwide: (gs) => gs.prestigeCount >= 25,
            goldenTouch: (gs) => gs.goldenChickensClicked >= 1, goldRush: (gs) => gs.goldenChickensClicked >= 10, goldFever: (gs) => gs.goldenChickensClicked >= 50,
            eggGreen: (gs) => gs.clickedColoredEggs['green'], eggRed: (gs) => gs.clickedColoredEggs['red'], eggPink: (gs) => gs.clickedColoredEggs['pink'],
            eggOrange: (gs) => gs.clickedColoredEggs['orange'], eggYellow: (gs) => gs.clickedColoredEggs['yellow'], eggWhite: (gs) => gs.clickedColoredEggs['white'],
            eggBlack: (gs) => gs.clickedColoredEggs['black'], eggBlue: (gs) => gs.clickedColoredEggs['blue'], eggPurple: (gs) => gs.clickedColoredEggs['purple'],
            eggGold: (gs) => gs.clickedColoredEggs['gold'],
            impatient: (gs) => gs.failedBuys >= 50, license: (gs) => gs.licenseClicked, reset: (gs) => gs.resets > 0,
            lazy: (gs) => gs.totalClicks === 0 && gs.timePlayed >= 120,
            loner: (gs) => gs.totalEggs >= 1e6 && gs.upgrades.worker === 0,
            afk: (gs) => gs.timeSinceLastClick >= 900,
            indecisive: (gs) => gs.modalOpens >= 50,
            justTheBasics: (gs) => gs.totalEggs >= 1e7 && Object.keys(gs.chickens).every(c => c === 'leghorn' || gs.chickens[c] === 0),
            allUpgrades: (gs) => Object.keys(CONFIG.UPGRADES).every(u => gs.upgrades[u] > 0),
            allChickens: (gs) => Object.keys(CONFIG.CHICKENS).every(c => gs.chickens[c] > 0),
            eggCollector: (gs) => Object.keys(CONFIG.COLORED_EGGS).every(c => gs.clickedColoredEggs[c]),
        };

        // --- utils.js content ---
        function formatNumber(num) {
            if (num === null || isNaN(num) || !isFinite(num)) return '0';
            if (num < 1000) return num.toFixed(0);
            const suffixes = ["", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"];
            const i = Math.floor(Math.log10(num) / 3);
            if (i >= suffixes.length) return num.toExponential(2);
            return (num / Math.pow(1000, i)).toFixed(2) + suffixes[i];
        }
        function calculateCost(base, level, exponent = 1.15, gameState) {
            let cost = Math.floor(base * Math.pow(exponent, level));
            if (gameState && gameState.activeBuffs.discount) {
                cost = Math.floor(cost * (1 - gameState.activeBuffs.discount.value));
            }
            return cost;
        }
        function generateAchievementScreenshot(id, gameState) {
            if (!id || !achievements[id]) return;
            const ach = achievements[id];
            const nickname = gameState.nickname || "A Farmer";
            const timestamp = new Date().toLocaleString();
            document.getElementById('screenshot-nickname').textContent = nickname;
            document.getElementById('screenshot-ach-name').textContent = `"${ach.name}"`;
            document.getElementById('screenshot-ach-desc').textContent = ach.description;
            document.getElementById('screenshot-date').textContent = `Unlocked on ${timestamp}`;
            const template = document.getElementById('achievement-screenshot-template');
            html2canvas(template, { useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `chicken-clicker-achievement-${id}.png`;
                link.href = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                link.click();
            });
        };
        const getAchievementBonus = (gs) => {
            const totalBonus = gs.unlockedAchievements.reduce((sum, id) => {
                const bonusValue = achievements[id]?.bonus || 1;
                return sum + (bonusValue - 1);
            }, 0);
            return 1 + totalBonus;
        };
        const getReputationBonus = (gs) => 1 + (gs.reputation || 0) * 0.05;
        const getEventModifier = (gs) => gs.event.active ? gs.event.modifier : 1;
        const getBuffModifier = (gs, buffType, defaultValue = 1) => (gs.activeBuffs[buffType] ? gs.activeBuffs[buffType].value : defaultValue);
        const getBoostMultiplier = (gs) => getBuffModifier(gs, 'boostMultiplier');
        const getBaseEggsPerSecond = (gs) => {
            let baseEps = gs.upgrades.worker * gs.chickens.leghorn * 1;
            baseEps += gs.chickens.brahma * (baseEps * 5);
            return baseEps;
        }
        const getEggsPerSecond = (gs) => {
            const baseEps = getBaseEggsPerSecond(gs);
            const interestCap = baseEps > 0 ? baseEps * 10 : 1000;
            const nestEggInterest = gs.upgrades.nestEggIRA > 0 ? Math.min(baseEps * 0.001 * gs.upgrades.nestEggIRA, interestCap) : 0;
            const peckingOrderBonus = 1 + (gs.upgrades.peckingOrder * 0.1);
            const bantyBonus = Math.pow(1.1, gs.chickens.banty);
            const totalBuildings = Object.values(gs.upgrades).reduce((a, b) => a + b, 0) + Object.values(gs.chickens).reduce((a, b) => a + b, 0);
            const cluckworkBonus = 1 + (gs.upgrades.cluckworkAutomation * 0.05 * totalBuildings);
            return (baseEps + nestEggInterest) * getAchievementBonus(gs) * getReputationBonus(gs) * getEventModifier(gs) * getBoostMultiplier(gs) * gs.permanentBonus * peckingOrderBonus * bantyBonus * cluckworkBonus;
        };
        const getEggsPerClick = (gs) => {
            const loomBoost = 1 + (gs.upgrades.loom * 0.25);
            const baseEpc = 1 + gs.upgrades.incubator;
            const peckingOrderBonus = 1 + (gs.upgrades.peckingOrder * 0.1);
            const bantyBonus = Math.pow(1.1, gs.chickens.banty);
            return Math.floor(baseEpc * loomBoost * getAchievementBonus(gs) * getReputationBonus(gs) * getEventModifier(gs) * getBoostMultiplier(gs) * gs.permanentBonus * peckingOrderBonus * bantyBonus * getBuffModifier(gs, 'clickFrenzy'));
        };

        // --- ui.js content ---
        const elements = {
            nicknameInput: document.getElementById('nickname-input'),
            chicken: document.getElementById('chicken'),
            eggCounter: document.getElementById('egg-counter'),
            featherCounter: document.getElementById('feather-counter'),
            epsCounter: document.getElementById('eggs-per-second'),
            epcCounter: document.getElementById('eggs-per-click'),
            achievementsList: document.getElementById('achievements-list'),
            goldenChicken: document.getElementById('golden-chicken'),
            toast: document.getElementById('achievement-toast'),
            toastTitle: document.getElementById('toast-title'),
            toastDescription: document.getElementById('toast-description'),
            prestigeButton: document.getElementById('prestige-button'),
            reputationPointsEl: document.getElementById('reputation-points'),
            reputationBonusEl: document.getElementById('reputation-bonus'),
            resetButton: document.getElementById('reset-button'),
            licenseSummary: document.getElementById('license-summary'),
            eventBanner: document.getElementById('event-banner'),
            nameModal: document.getElementById('name-modal'),
            initialNicknameInput: document.getElementById('initial-nickname-input'),
            startGameBtn: document.getElementById('start-game-btn'),
            playerNameDisplay: document.getElementById('player-name-display'),
            upgradesListContainer: document.getElementById('upgrades-list'),
            coopListContainer: document.getElementById('coop-list'),
            coloredEggContainer: document.getElementById('colored-egg-container'),
            versionNumberEl: document.getElementById('version-number'),
            exportSaveClipboardBtn: document.getElementById('export-save-clipboard'),
            exportSaveFileBtn: document.getElementById('export-save-file'),
            importSaveText: document.getElementById('import-save-text'),
            importSaveTextBtn: document.getElementById('import-save-text-btn'),
            importSaveFileBtn: document.getElementById('import-save-file-btn'),
            importFileInput: document.getElementById('import-file-input'),
        };
        function buildUpgradeShop() {
            elements.upgradesListContainer.innerHTML = '';
            for (const id in CONFIG.UPGRADES) {
                const upgrade = CONFIG.UPGRADES[id];
                const el = document.createElement('div');
                el.className = `bg-${upgrade.color}-200 p-4 rounded-lg border-2 border-${upgrade.color}-400`;
                el.innerHTML = `
                    <h4 class="text-2xl funky-font">${upgrade.name}</h4>
                    <p class="text-gray-600 mb-2">${upgrade.desc}</p>
                    <p>Level: <span id="${id}-level" class="font-bold">0</span></p>
                    <button id="buy-${id}" class="w-full mt-2 funky-button bg-${upgrade.color}-500 text-white">Buy for <span id="${id}-cost">10</span> ${upgrade.currency === 'eggs' ? 'Eggs' : 'Feathers'}</button>
                `;
                elements.upgradesListContainer.appendChild(el);
            }
        }
        function buildCoop() {
            elements.coopListContainer.innerHTML = '';
            for (const id in CONFIG.CHICKENS) {
                const chicken = CONFIG.CHICKENS[id];
                const el = document.createElement('div');
                el.className = `bg-${chicken.color}-200 p-4 rounded-lg border-2 border-${chicken.color}-400`;
                let buttonHtml = `<button id="buy-${id}" class="w-full mt-2 funky-button bg-${chicken.color}-500 text-white">Buy for <span id="${id}-cost">1000</span> Eggs</button>`;
                
                el.innerHTML = `
                    <h4 class="text-2xl funky-font">${chicken.name}</h4>
                    <p class="text-gray-600 mb-2">${chicken.desc}</p>
                    <p>Owned: <span id="${id}-chickens" class="font-bold">0</span></p>
                    ${buttonHtml}
                `;
                elements.coopListContainer.appendChild(el);
            }
        }
        function updateUI(gameState) {
            elements.eggCounter.textContent = `${formatNumber(gameState.eggs)} Eggs`;
            elements.featherCounter.textContent = `${formatNumber(gameState.feathers)} Golden Feathers`;
            elements.epsCounter.textContent = `per second: ${formatNumber(getEggsPerSecond(gameState))}`;
            elements.epcCounter.textContent = `per click: ${formatNumber(getEggsPerClick(gameState))}`;

            for (const id in CONFIG.UPGRADES) {
                const upgrade = CONFIG.UPGRADES[id];
                const levelEl = document.getElementById(`${id}-level`);
                const costEl = document.getElementById(`${id}-cost`);
                const buttonEl = document.getElementById(`buy-${id}`);
                if (!levelEl || !costEl || !buttonEl) continue;

                levelEl.textContent = formatNumber(gameState.upgrades[id]);
                const cost = calculateCost(upgrade.baseCost, gameState.upgrades[id], upgrade.exponent, gameState);
                costEl.textContent = formatNumber(cost);
                buttonEl.disabled = gameState[upgrade.currency] < cost;
            }

            for (const id in CONFIG.CHICKENS) {
                const chicken = CONFIG.CHICKENS[id];
                const ownedEl = document.getElementById(`${id}-chickens`);
                const costEl = document.getElementById(`${id}-cost`);
                const buttonEl = document.getElementById(`buy-${id}`);
                if (!ownedEl || !costEl || !buttonEl) continue;

                ownedEl.textContent = formatNumber(gameState.chickens[id]);
                const cost = calculateCost(chicken.baseCost, gameState.chickens[id], chicken.exponent, gameState);
                costEl.textContent = formatNumber(cost);
                buttonEl.disabled = gameState.eggs < cost;
            }
            
            elements.reputationPointsEl.textContent = formatNumber(gameState.reputation);
            elements.reputationBonusEl.textContent = ((getReputationBonus(gameState) - 1) * 100).toFixed(0);
            elements.prestigeButton.disabled = gameState.eggs < CONFIG.PRESTIGE_COST;
            
            // --- New UI logic for bonus breakdown ---
            const achBonus = getAchievementBonus(gameState);
            const repBonus = getReputationBonus(gameState);
            const permBonus = gameState.permanentBonus;

            const achBonusUI = document.getElementById('achievement-bonus-ui');
            const permBonusUI = document.getElementById('permanent-bonus-ui');
            const totalMultiplierUI = document.getElementById('total-multiplier-ui');

            if (achBonusUI) achBonusUI.textContent = `+${((achBonus - 1) * 100).toFixed(0)}`;
            if (permBonusUI) permBonusUI.textContent = `x${permBonus.toFixed(2)}`;
            if (totalMultiplierUI) totalMultiplierUI.textContent = `x${(achBonus * repBonus * permBonus).toFixed(2)}`;

            if(gameState.event.active) {
                elements.eventBanner.style.display = 'block';
                elements.eventBanner.textContent = `${gameState.event.type}! ${Math.ceil(gameState.event.duration)}s left!`;
            } else {
                elements.eventBanner.style.display = 'none';
            }
        }
        function renderAchievements(gameState) {
            elements.achievementsList.innerHTML = '';
            Object.keys(achievements).forEach(id => {
                const ach = achievements[id];
                const isUnlocked = gameState.unlockedAchievements.includes(id);
                if(ach.hidden && !isUnlocked) return;

                const el = document.createElement('div');
                el.className = `p-2 rounded-lg transition-all duration-300 font-semibold flex justify-between items-center ${isUnlocked ? 'bg-yellow-300 text-yellow-800' : 'bg-gray-200 text-gray-500'}`;
                el.innerHTML = `<div><strong>${ach.name}</strong><p class="text-sm font-normal">${ach.description}</p></div>`;
                
                if (isUnlocked) {
                    const shareIcon = document.createElement('span');
                    shareIcon.innerHTML = `<svg class="w-6 h-6 cursor-pointer hover:scale-110 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-3V6c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zM9 6h6v2H9V6zm11 12H4v-8h16v8zm-9-4h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>`;
                    shareIcon.title = "Share Achievement";
                    shareIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        generateAchievementScreenshot(id, gameState);
                    });
                    el.appendChild(shareIcon);
                }
                
                elements.achievementsList.appendChild(el);
            });
        }
        function showToast(title, description) {
            elements.toastTitle.textContent = title;
            elements.toastDescription.textContent = description;
            elements.toast.classList.add('show');
            setTimeout(() => elements.toast.classList.remove('show'), 4000);
        };
        function showFloatingText(text, event, isSuper = false) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            if (isSuper) {
                el.classList.add('super-click-text');
            }
            el.textContent = text;
            const chickenContainer = document.querySelector('.chicken-container');
            if (!chickenContainer) return;
            chickenContainer.appendChild(el);
            
            const containerRect = chickenContainer.getBoundingClientRect();
            el.style.left = `${event.clientX - containerRect.left - (el.offsetWidth / 2)}px`;
            el.style.top = `${event.clientY - containerRect.top - (el.offsetHeight / 2)}px`;
            
            setTimeout(() => {
                if (el.parentElement) {
                    el.parentElement.removeChild(el);
                }
            }, 1450);
        };

        // --- game.js content ---
        let gameState = {};
        const initialGameState = {
            nickname: null, eggs: 0, totalEggs: 0, feathers: 0, totalFeathers: 0, totalClicks: 0,
            upgrades: {
                worker: 0, incubator: 0, loom: 0, featherForecast: 0, eggstraClicks: 0, 
                cluckworkAutomation: 0, peckingOrder: 0, nestEggIRA: 0, fowlLanguage: 0
            },
            chickens: { 
                leghorn: 1, silkie: 0, rooster: 0, orpington: 0, wyandotte: 0, doja: 0,
                brahma: 0, serama: 0, banty: 0
            },
            unlockedAchievements: [], reputation: 0, timePlayed: 0, failedBuys: 0, licenseClicked: false,
            goldenChickensClicked: 0, prestigeCount: 0, resets: 0,
            event: { active: false, type: null, duration: 0, modifier: 1 },
            activeBuffs: {}, permanentBonus: 1, clickedColoredEggs: {},
            oracleTimer: 0,
            lastSuperClickTime: 0, superClickChain: 0, modalOpens: 0, timeSinceLastClick: 0,
        };

        function clickChicken(event) {
            let epc = getEggsPerClick(gameState);
            if (gameState.upgrades.eggstraClicks > 0 && Math.random() < (gameState.upgrades.eggstraClicks * 0.05)) {
                epc *= 10;
            }
            gameState.eggs += epc;
            gameState.totalEggs += epc;
            showFloatingText(`+${formatNumber(epc)}`, event);

            const superClickChance = (gameState.chickens.doja * 0.001) * (gameState.activeBuffs.superClickFrenzy ? gameState.activeBuffs.superClickFrenzy.value : 1);
            if (gameState.chickens.doja > 0 && Math.random() < superClickChance) {
                const now = Date.now();
                if (now - gameState.lastSuperClickTime < 10000) {
                    gameState.superClickChain++;
                } else {
                    gameState.superClickChain = 0;
                }
                gameState.lastSuperClickTime = now;
                const superClickBonus = (getEggsPerSecond(gameState) * 3600) * (1 + gameState.superClickChain * 0.1);
                gameState.eggs += superClickBonus;
                gameState.totalEggs += superClickBonus;
                showFloatingText(`+${formatNumber(superClickBonus)}!`, event, true);
            }
            gameState.totalClicks++;
            gameState.timeSinceLastClick = 0;
        }

        function buyUpgrade(id) {
            const upgrade = CONFIG.UPGRADES[id];
            const cost = calculateCost(upgrade.baseCost, gameState.upgrades[id], upgrade.exponent, gameState);
            if (gameState[upgrade.currency] >= cost) {
                gameState[upgrade.currency] -= cost;
                gameState.upgrades[id]++;
            } else {
                gameState.failedBuys++;
            }
        }

        function buyChicken(id) {
            const chicken = CONFIG.CHICKENS[id];
            const cost = calculateCost(chicken.baseCost, gameState.chickens[id], chicken.exponent, gameState);
            if (gameState.eggs >= cost) {
                gameState.eggs -= cost;
                gameState.chickens[id]++;
            } else {
                gameState.failedBuys++;
            }
        }

        function spawnGoldenChicken() {
            const containerRect = elements.coloredEggContainer.getBoundingClientRect();
            elements.goldenChicken.style.top = `${Math.random() * (containerRect.height - 120)}px`;
            elements.goldenChicken.style.left = `${Math.random() * (containerRect.width - 80)}px`;
            elements.goldenChicken.style.display = 'block';
            elements.goldenChicken.style.opacity = '1';
            setTimeout(() => {
                elements.goldenChicken.style.opacity = '0';
                setTimeout(() => elements.goldenChicken.style.display = 'none', 500);
            }, 5000);
        }

        function clickGoldenChicken(event) {
            const bonus = Math.max(getEggsPerClick(gameState) * 100, getEggsPerSecond(gameState) * 10 * 60);
            gameState.eggs += bonus;
            gameState.totalEggs += bonus;
            gameState.goldenChickensClicked++;
            showFloatingText(`+${formatNumber(bonus)}!`, event);
            elements.goldenChicken.style.display = 'none';
        }

        function spawnColoredEgg() {
            if (Math.random() > CONFIG.COLORED_EGG_SPAWN_CHANCE) return;
            const roll = Math.random() * 100;
            let cumulativeLikelihood = 0;
            for (const id in CONFIG.COLORED_EGGS) {
                const egg = CONFIG.COLORED_EGGS[id];
                cumulativeLikelihood += egg.likelihood;
                if (roll < cumulativeLikelihood) {
                    const eggEl = document.createElement('div');
                    eggEl.className = 'colored-egg';
                    eggEl.style.backgroundColor = egg.color;
                    eggEl.style.borderRadius = '50% 50% 50% 50% / 60% 60% 40% 40%';
                    eggEl.style.boxShadow = `inset -5px -5px 10px rgba(0,0,0,0.3), 0 0 10px ${egg.color}`;
                    const containerRect = elements.coloredEggContainer.getBoundingClientRect();
                    eggEl.style.top = `${Math.random() * (containerRect.height - 120)}px`;
                    eggEl.style.left = `${Math.random() * (containerRect.width - 40)}px`;
                    eggEl.style.display = 'block';
                    eggEl.addEventListener('click', () => { applyEggEffect(id); eggEl.remove(); }, { once: true });
                    elements.coloredEggContainer.appendChild(eggEl);
                    setTimeout(() => { if (eggEl.parentElement) eggEl.parentElement.removeChild(eggEl); }, 10000);
                    return;
                }
            }
        }

        function applyEggEffect(id) {
            const egg = CONFIG.COLORED_EGGS[id];
            gameState.clickedColoredEggs[id] = (gameState.clickedColoredEggs[id] || 0) + 1;
            let bonusTitle = `${id.charAt(0).toUpperCase() + id.slice(1)} Egg Bonus!`;
            let bonusDescription = '';
            switch(egg.effect) {
                case 'discount': bonusDescription = `Next ${egg.duration} upgrades are ${egg.value * 100}% cheaper!`; break;
                case 'clickFrenzy': bonusDescription = `Click power is ${egg.value}x for ${egg.duration} seconds!`; break;
                case 'instantGain': const gain = getEggsPerSecond(gameState) * egg.value; gameState.eggs += gain; gameState.totalEggs += gain; bonusDescription = `Instantly gained ${formatNumber(gain)} eggs!`; break;
                case 'featherFrenzy': bonusDescription = `Golden Feather chance is doubled for ${egg.duration / 60} minutes!`; break;
                case 'goldRush': bonusDescription = `A rush of ${egg.value} Golden Chickens has appeared!`; for(let i=0; i<egg.value; i++) spawnGoldenChicken(); break;
                case 'boostMultiplier': bonusDescription = `All egg production is doubled for ${egg.duration} seconds!`; break;
                case 'superClickFrenzy': bonusDescription = `Super Click chance is doubled for ${egg.duration} seconds!`; break;
                case 'prestigeBuff': bonusDescription = `Your next prestige will grant an extra ${egg.value * 100}% Reputation!`; break;
                case 'prestigePercent': const prestigeGain = CONFIG.PRESTIGE_COST * egg.value; gameState.eggs += prestigeGain; gameState.totalEggs += prestigeGain; bonusDescription = `Gained ${formatNumber(prestigeGain)} eggs toward your next prestige!`; break;
                case 'permanentBonus': bonusDescription = `Permanently increased all egg production by ${egg.value * 100}%!`; break;
            }
            showToast(bonusTitle, bonusDescription);
            if (egg.duration > 0) gameState.activeBuffs[egg.effect] = { value: egg.value, duration: egg.duration };
            else if (egg.effect === 'permanentBonus') gameState.permanentBonus += egg.value;
            else if (egg.effect === 'prestigeBuff') gameState.activeBuffs[egg.effect] = { value: (gameState.activeBuffs[egg.effect]?.value || 0) + egg.value };
            checkAchievements();
        }

        function saveGame() { localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(gameState)); }
        function loadGame() {
            const savedState = localStorage.getItem(CONFIG.SAVE_KEY);
            gameState = savedState ? JSON.parse(savedState) : { ...initialGameState };
            gameState = deepMerge(initialGameState, gameState);

            const resetCount = localStorage.getItem('chickenClickerResetCount');
            if (resetCount) {
                gameState.resets = parseInt(resetCount, 10);
                localStorage.removeItem('chickenClickerResetCount');
            }

            if (!gameState.nickname) {
                elements.nameModal.style.display = 'flex';
            } else {
                elements.playerNameDisplay.textContent = gameState.nickname;
            }
            elements.nicknameInput.value = gameState.nickname;
        }
        function deepMerge(target, source) {
            const output = { ...target };
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key])) {
                        if (!(key in target)) Object.assign(output, { [key]: source[key] });
                        else output[key] = deepMerge(target[key], source[key]);
                    } else {
                        Object.assign(output, { [key]: source[key] });
                    }
                });
            }
            return output;
        }
        function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }
        function hardReset() {
            if (confirm("Are you sure you want to completely reset your game? This cannot be undone.")) {
                localStorage.setItem('chickenClickerResetCount', (gameState.resets || 0) + 1);
                localStorage.removeItem(CONFIG.SAVE_KEY);
                location.reload();
            }
        }
        
        function exportSave(toFile = false) {
            try {
                const saveString = btoa(JSON.stringify(gameState));
                if (toFile) {
                    const blob = new Blob([saveString], {type: "text/plain;charset=utf-8"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `chicken_clicker_save_${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("Success", "Save file downloaded!");
                } else {
                    navigator.clipboard.writeText(saveString).then(() => {
                        showToast("Success", "Save data copied to clipboard!");
                    }, () => {
                        showToast("Error", "Could not copy to clipboard.");
                    });
                }
            } catch (e) {
                showToast("Error", "Could not export save data.");
                console.error("Export failed:", e);
            }
        }

        function importSave(saveString) {
            if (!saveString) {
                showToast("Error", "No save data provided.");
                return;
            }
            try {
                const decodedString = atob(saveString);
                const newGameState = JSON.parse(decodedString);
                
                if (typeof newGameState.eggs !== 'number' || typeof newGameState.upgrades.worker !== 'number') {
                    throw new Error("Invalid save file structure.");
                }

                localStorage.setItem(CONFIG.SAVE_KEY, decodedString);
                showToast("Success", "Game imported! Reloading...");
                setTimeout(() => location.reload(), 1500);

            } catch (e) {
                showToast("Error", "Invalid or corrupt save data.");
                console.error("Import failed:", e);
            }
        }

        // --- NEW: Offline Progress Calculation ---
        function calculateOfflineProgress() {
            const lastTime = localStorage.getItem('chickenClickerExitTime');
            if (!lastTime) return;

            localStorage.removeItem('chickenClickerExitTime'); // Clean up immediately

            let offlineSeconds = (Date.now() - parseInt(lastTime, 10)) / 1000;
            if (offlineSeconds <= 10) return; // Don't award for brief periods

            // Cap offline time to 24 hours to prevent exploitation
            const maxOfflineSeconds = 86400; 
            offlineSeconds = Math.min(offlineSeconds, maxOfflineSeconds);

            // Calculate earnings
            const offlineEps = getEggsPerSecond(gameState);
            const eggsGained = Math.floor(offlineEps * offlineSeconds);
            
            const featherChancePerSecond = (gameState.chickens.silkie * (0.1 + (gameState.upgrades.featherForecast * 0.01)));
            const feathersGained = Math.floor(featherChancePerSecond * offlineSeconds);

            const repChancePerSecond = gameState.chickens.rooster * 0.01;
            const repGained = repChancePerSecond * offlineSeconds;

            if (eggsGained <= 0 && feathersGained <= 0 && repGained <= 0) return;

            // Update game state
            gameState.eggs += eggsGained;
            gameState.totalEggs += eggsGained;
            gameState.feathers += feathersGained;
            // gameState.totalFeathers += feathersGained; // Decided against adding to total for now to avoid achievement exploits
            gameState.reputation += repGained;

            // Update and show the modal
            const timeAwayHours = Math.floor(offlineSeconds / 3600);
            const timeAwayMinutes = Math.floor((offlineSeconds % 3600) / 60);
            document.getElementById('offline-time').textContent = `${timeAwayHours}h ${timeAwayMinutes}m`;
            
            const offlineEggsLine = document.getElementById('offline-eggs-line');
            if (eggsGained > 0) {
                offlineEggsLine.textContent = `+${formatNumber(eggsGained)} Eggs`;
                offlineEggsLine.classList.remove('hidden');
            }

            const offlineFeathersLine = document.getElementById('offline-feathers-line');
             if (feathersGained > 0) {
                offlineFeathersLine.textContent = `+${formatNumber(feathersGained)} Golden Feathers`;
                offlineFeathersLine.classList.remove('hidden');
            }

            const offlineRepLine = document.getElementById('offline-rep-line');
             if (repGained > 0) {
                offlineRepLine.textContent = `+${formatNumber(repGained)} Reputation`;
                offlineRepLine.classList.remove('hidden');
            }

            document.getElementById('offline-progress-modal').style.display = 'flex';
        }


        function gameLoop() {
            try {
                const secondsPassed = CONFIG.GAME_TICK_INTERVAL;
                const eps = getEggsPerSecond(gameState);
                gameState.eggs += eps * secondsPassed;
                gameState.totalEggs += eps * secondsPassed;
                gameState.timePlayed += secondsPassed;
                gameState.timeSinceLastClick = (gameState.timeSinceLastClick || 0) + secondsPassed;
                for (const buff in gameState.activeBuffs) {
                    if (gameState.activeBuffs[buff].duration > 0) {
                        gameState.activeBuffs[buff].duration -= secondsPassed;
                        if (gameState.activeBuffs[buff].duration <= 0) delete gameState.activeBuffs[buff];
                    }
                }
                if(gameState.event.active) {
                    gameState.event.duration -= secondsPassed;
                    if(gameState.event.duration <= 0) gameState.event.active = false;
                }
                const featherChance = 0.1 + (gameState.upgrades.featherForecast * 0.01);
                const featherFrenzyBonus = getBuffModifier(gameState, 'featherFrenzy');
                if(Math.random() < (gameState.chickens.silkie * featherChance * featherFrenzyBonus * secondsPassed)) {
                    gameState.feathers++;
                    gameState.totalFeathers++;
                }
                gameState.reputation += gameState.chickens.rooster * 0.01 * secondsPassed;
                if (gameState.chickens.serama > 0 && Math.random() < (gameState.chickens.serama * 0.01 * secondsPassed)) {
                    let cheapest = null, minCost = Infinity;
                    for(const id in CONFIG.UPGRADES) {
                        const cost = calculateCost(CONFIG.UPGRADES[id].baseCost, gameState.upgrades[id], CONFIG.UPGRADES[id].exponent, gameState);
                        if(cost < minCost) { minCost = cost; cheapest = id; }
                    }
                    if(cheapest) gameState.upgrades[cheapest]++;
                }

                if (gameState.chickens.orpington > 0) {
                    gameState.oracleTimer = (gameState.oracleTimer || 0) + secondsPassed;
                    if (gameState.oracleTimer >= 600) {
                        const oracles = gameState.chickens.orpington;
                        const baseBonus = getEggsPerSecond(gameState) * 1800;
                        const randomMultiplier = Math.random() + 0.5;
                        const totalBonus = Math.floor(baseBonus * oracles * randomMultiplier);

                        if (totalBonus > 0) {
                            gameState.eggs += totalBonus;
                            gameState.totalEggs += totalBonus;
                            showToast("Oracle's Blessing!", `Your Orpington Oracles granted you ${formatNumber(totalBonus)} eggs!`);
                        }
                        gameState.oracleTimer = 0;
                    }
                }

                updateUI(gameState);
                checkAchievements();
            } catch (error) {
                console.error("Game loop crashed:", error);
            }
        }

        function checkAchievements() {
            Object.keys(achievements).forEach(id => {
                if (!gameState.unlockedAchievements.includes(id) && achievementConditions[id](gameState)) {
                    gameState.unlockedAchievements.push(id);
                    const ach = achievements[id];
                    if (!ach.noToast) showToast('Achievement Unlocked!', ach.name);
                    renderAchievements(gameState);
                }
            });
        }

        function prestige() {
            if (gameState.eggs >= CONFIG.PRESTIGE_COST) {
                if(confirm(`Are you sure you want to sell the coop? This will reset your eggs, upgrades, and chickens for Reputation points.`)){
                    const { nickname, unlockedAchievements, permanentBonus, resets } = gameState;
                    const eggsForPrestige = Math.floor(Math.sqrt(gameState.totalEggs / 1e11));
                    const prestigeBuff = gameState.activeBuffs.prestigeBuff ? gameState.activeBuffs.prestigeBuff.value : 0;

                    const reputationGained = Math.floor((eggsForPrestige > 0 ? eggsForPrestige : 1) * (1 + prestigeBuff));
                    const wyandotteBonus = 1 + (gameState.chickens.wyandotte * 0.01);
                    const finalGainedRep = Math.floor(reputationGained * wyandotteBonus);

                    let newRep = (gameState.reputation || 0) + finalGainedRep;

                    if (!isFinite(newRep)) {
                        newRep = gameState.reputation || 0;
                    }

                    const prestigeCount = (gameState.prestigeCount || 0) + 1;
                    const unlockedHidden = unlockedAchievements.filter(id => achievements[id]?.hidden);
                    
                    let newGameState = deepMerge(initialGameState, {});
                    newGameState.nickname = nickname;
                    newGameState.reputation = newRep;
                    newGameState.prestigeCount = prestigeCount;
                    newGameState.unlockedAchievements = unlockedHidden;
                    newGameState.permanentBonus = permanentBonus;
                    newGameState.resets = resets;
                    gameState = newGameState;

                    saveGame();
                    location.reload();
                }
            }
        }

        function triggerEvent() {
            if(gameState.event.active) return;
            gameState.event = { active: true, type: "Feeding Frenzy", duration: 60, modifier: 2 };
        }

        function setupEventListeners() {
            elements.startGameBtn.addEventListener('click', () => {
                const name = elements.initialNicknameInput.value.trim();
                if (name) {
                    gameState.nickname = name;
                    elements.nicknameInput.value = name;
                    elements.nameModal.style.display = 'none';
                    elements.playerNameDisplay.textContent = name;
                    saveGame();
                }
            });
            elements.chicken.addEventListener('click', clickChicken);
            elements.goldenChicken.addEventListener('click', clickGoldenChicken);
            const navButtons = document.querySelectorAll('.nav-button');
            const closeButtons = document.querySelectorAll('.close-modal-btn');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modalId = button.dataset.modal;
                    document.getElementById(modalId).style.display = 'flex';
                    gameState.modalOpens++;
                });
            });
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    button.closest('.modal-screen').style.display = 'none';
                });
            });
            elements.nicknameInput.addEventListener('change', (e) => { 
                gameState.nickname = e.target.value || "A Farmer";
                elements.playerNameDisplay.textContent = gameState.nickname;
            });
            elements.prestigeButton.addEventListener('click', prestige);
            elements.resetButton.addEventListener('click', hardReset);
            elements.licenseSummary.addEventListener('click', () => { gameState.licenseClicked = true; });
            
            // --- NEW: Offline Progress Listeners ---
            const saveExitTime = () => localStorage.setItem('chickenClickerExitTime', Date.now());
            window.addEventListener('beforeunload', saveExitTime);
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveExitTime();
                }
            });
            
            // Save/Import Listeners
            elements.exportSaveClipboardBtn.addEventListener('click', () => exportSave(false));
            elements.exportSaveFileBtn.addEventListener('click', () => exportSave(true));
            elements.importSaveTextBtn.addEventListener('click', () => importSave(elements.importSaveText.value));
            elements.importSaveFileBtn.addEventListener('click', () => elements.importFileInput.click());
            elements.importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => importSave(e.target.result);
                    reader.readAsText(file);
                }
            });


            for (const id in CONFIG.UPGRADES) {
                document.getElementById(`buy-${id}`).addEventListener('click', () => buyUpgrade(id));
            }
            for (const id in CONFIG.CHICKENS) {
                document.getElementById(`buy-${id}`).addEventListener('click', () => buyChicken(id));
            }
        }

        function initialize() {
            if (elements.versionNumberEl) {
                elements.versionNumberEl.textContent = CONFIG.GAME_VERSION;
            }
            buildUpgradeShop();
            buildCoop();
            loadGame();
            
            // --- NEW: Calculate offline progress after loading game ---
            calculateOfflineProgress();

            renderAchievements(gameState);
            updateUI(gameState);
            setupEventListeners();
            setInterval(gameLoop, CONFIG.GAME_TICK_INTERVAL * 1000);
            setInterval(saveGame, CONFIG.SAVE_INTERVAL * 1000);
            setInterval(spawnGoldenChicken, CONFIG.GOLDEN_CHICKEN_SPAWN_INTERVAL * 1000);
            setInterval(triggerEvent, CONFIG.RANDOM_EVENT_INTERVAL * 1000);
            setInterval(spawnColoredEgg, CONFIG.COLORED_EGG_ATTEMPT_INTERVAL * 1000);
        }

        initialize();
    </script>
</body>
</html>
